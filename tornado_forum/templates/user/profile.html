{% extends 'core/home.html' %}

{% block title %}
{{ profile_user.username }}
{% end %}

{% block style %}
<link rel="stylesheet" href="{{ static_url('css/profile.css') }}">
{% end %}

{% block content %}
<div class="profile-container" data-profile-id="{{profile_user.id}}">
    <h1>{{ profile_user.username }}</h1>
    {% if not is_own_profile %}
        <button id="chat-button" data-user-id="{{ profile_user.id }}">
            Chat with {{ profile_user.username }}
        </button>
    {% end %}
    <hr>
    <div class="user-activity">
        <div class="user-posts">
            <button class="post-display-button">Posts</button>
        </div>
        <div class="user-comments">
            <button class="comment-display-button">Comments</button>
        </div>
        <div class="liked-posts">
            <button class="likes-display-button">Liked Posts</button>
        </div>
        <div class="disliked-posts">
            <button class="dislikes-display-button">Disliked Posts</button>
        </div>
    </div>
    <div class="user-activity-content" data-current-content="postsgh">
        <!-- Rendered by javascript based on the user selection -->
        <!-- If the user wants to see the posts, he will click on posts. -->
        {% if topics %}
            {% for topic in topics %}
                <div id="topic-{{topic.id}}" class="topic-list">
                    <a href="/topic/{{topic.id}}">{{topic.title}}</a>
                </div>
            {% end %}
        {% else %}
            <p>{{ profile_user.username }} has not created any posts yet.</p>
        {% end %}
    </div>
</div>
{% end %}

{% block javascript %}
<script src="{{ static_url('js/profileHandler.js') }}"></script>
{% if not is_own_profile %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatButton = document.getElementById('chat-button');
    chatButton.addEventListener('click', function() {
        const userId = this.dataset.userId;
        
        fetch('/api/chat/dm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-XSRFToken': getCookie('_xsrf')
            },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => {
            if (response.ok) {
                // Redirect to the main chat page
                window.location.href = '/chat';
            } else {
                console.error('Failed to initiate chat.');
                alert('Could not start the chat. Please try again later.');
            }
        });
    });
});
</script>
{% end %}
{% end %}